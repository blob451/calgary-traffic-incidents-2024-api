name: Render Keepalive

on:
  schedule:
    # Run every 5 minutes to mitigate GitHub cron jitter
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  ping:
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Resolve target URL
        id: vars
        run: |
          if [ -n "${{ secrets.KEEPALIVE_URL }}" ]; then
            echo "url=${{ secrets.KEEPALIVE_URL }}" >> $GITHUB_OUTPUT
          else
            echo "url=https://calgary-traffic-incidents-2024-api.onrender.com/" >> $GITHUB_OUTPUT
          fi
      - name: Ping deployed URL (with retry)
        env:
          URL: ${{ steps.vars.outputs.url }}
        run: |
          set -euxo pipefail
          echo "Pinging $URL"
          for i in 1 2 3; do
            code=$(curl -A "KeepaliveBot/1.0" -fsS -m 20 -o /dev/null -w "%{http_code}" "$URL" || echo "000")
            echo "Attempt $i -> HTTP $code"
            if [ "$code" != "000" ]; then
              break
            fi
            sleep 10
          done